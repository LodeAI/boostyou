<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BOOSTYOU.AI — Admin</title>

<!--
  Full Admin Page
  - Login with GitHub PAT (saved in localStorage)
  - Lists /data/content_YYYY_MM.json files
  - Load all month files, merge entries into a table
  - Add / Edit / Delete entries -> commits to GitHub via REST API
  - Mobile friendly, dark gaming style
-->

<style>
  /* ---------- Theme ---------- */
  :root{
    --bg:#05030a; --card:#0d0c11; --glass:rgba(255,255,255,0.04);
    --glass-border:rgba(255,255,255,0.07);
    --accent1:#00ff88; --accent2:#7c3aed; --accent3:#ff5c8a;
    --muted:rgba(255,255,255,0.65);
    --danger:#ff6b6b;
    --radius:14px;
    --maxw:1300px;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background: radial-gradient(ellipse at 10% 20%, rgba(124,58,237,0.06), transparent 20%),
                radial-gradient(ellipse at 90% 80%, rgba(0,255,136,0.03), transparent 20%),
                var(--bg);
    color: #fff;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    padding:24px;
  }

  /* ---------- Layout ---------- */
  .container { max-width:var(--maxw); margin: 0 auto; }
  .header {
    display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    margin-bottom:18px;
  }
  .brand { display:flex; gap:12px; align-items:center; }
  .logo {
    width:60px; height:60px; border-radius:12px;
    background: linear-gradient(135deg,var(--accent1),var(--accent2));
    display:flex; align-items:center; justify-content:center; font-weight:800; color:#051018;
    font-size:20px;
  }
  .title { font-size:20px; font-weight:800; letter-spacing:-0.3px; }
  .subtitle { font-size:12px; color:var(--muted); margin-top:2px; }

  .top-controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .card { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:16px; border:1px solid var(--glass-border); }
  .shadow-sm { box-shadow: 0 10px 30px rgba(2,6,23,0.4); }

  .grid { display:grid; gap:14px; }
  .grid.cols-3 { grid-template-columns: 360px 1fr 360px; }
  .grid.cols-2 { grid-template-columns: 1fr 420px; }

  label { display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
  input[type=text], input[type=url], input[type=password], input[type=datetime-local], select, textarea {
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--glass-border); background:rgba(255,255,255,0.02); color:#fff;
    font-size:14px;
  }
  .small { font-size:12px; color:var(--muted); }

  .btn {
    padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:14px;
  }
  .btn-primary { background: linear-gradient(90deg,var(--accent1),var(--accent2)); color:#051018; }
  .btn-ghost { background:transparent; border:1px solid var(--glass-border); color:var(--muted); }
  .btn-danger { background: linear-gradient(90deg,#ff6b6b,#ef4444); color:#fff; }
  .btn-sm { padding:6px 10px; font-size:13px; border-radius:8px; }

  .status { padding:10px; border-radius:10px; margin-bottom:12px; }
  .status.ok { background: rgba(16,185,129,0.08); color:#10b981; border:1px solid rgba(16,185,129,0.12); }
  .status.err { background: rgba(239,68,68,0.06); color:var(--danger); border:1px solid rgba(239,68,68,0.10); }

  table { width:100%; border-collapse:collapse; font-size:14px; }
  th,td { padding:10px 8px; border-bottom:1px solid rgba(255,255,255,0.03); vertical-align:middle; }
  th { color:var(--muted); text-align:left; font-weight:700; font-size:13px; }
  td small { color:var(--muted); display:block; font-size:12px; }

  .file-list { max-height:320px; overflow:auto; padding:8px; border-radius:8px; border:1px dashed var(--glass-border); background:transparent; }
  .file-item { padding:8px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; align-items:center; }
  .file-item:hover { background: rgba(255,255,255,0.01); }

  .muted { color:var(--muted); }

  .chips { display:flex; gap:8px; flex-wrap:wrap; }
  .chip { padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); font-size:13px; }

  /* Modal */
  .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:2000; padding:16px; }
  .modal.active { display:flex; }
  .modal-window { width:100%; max-width:780px; background:var(--card); border-radius:12px; padding:18px; border:1px solid var(--glass-border); }

  /* Responsiveness */
  @media (max-width:1100px) {
    .grid.cols-3 { grid-template-columns: 1fr; }
    .grid.cols-2 { grid-template-columns: 1fr; }
  }
  @media (max-width:600px) {
    .top-controls input { width:140px; }
    .logo { width:48px; height:48px; }
  }
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="logo">BY</div>
        <div>
          <div class="title">BOOSTYOU.AI — Admin</div>
          <div class="subtitle">Manage content_YYYY_MM.json • Add / Edit / Delete • Commits to GitHub</div>
        </div>
      </div>

      <div class="top-controls">
        <!-- Login area (when logged out) -->
        <div id="loginPanel" style="display:flex; gap:8px; align-items:center;">
          <input id="patField" type="password" placeholder="GitHub Personal Access Token (PAT)" style="width:360px" />
          <input id="ownerField" type="text" placeholder="Repo owner (username/org)" style="width:180px" />
          <input id="repoField"  type="text" placeholder="Repo name" style="width:180px" />
          <button id="loginBtn" class="btn btn-primary">Login</button>
        </div>

        <!-- Auth area (when logged in) -->
        <div id="authPanel" style="display:none; gap:8px; align-items:center;">
          <div class="small muted">Logged in as <strong id="whoDisplay">—</strong></div>
          <button id="testBtn" class="btn btn-ghost btn-sm">Test</button>
          <button id="refreshBtnTop" class="btn btn-ghost btn-sm">Refresh</button>
          <button id="logoutBtn" class="btn btn-ghost btn-sm">Logout</button>
        </div>
      </div>
    </header>

    <div id="statusArea"></div>

    <!-- Main grid: files | add form + table | filters / helper -->
    <main class="grid cols-3" style="align-items:start;">
      <!-- Left: Files list -->
      <aside class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-weight:800">Repository / Data</div>
          <div class="small muted">files in /data</div>
        </div>

        <div id="filesBox" class="file-list muted">
          Loading files...
        </div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="downloadMonthBtn" class="btn btn-ghost btn-sm">Download current month JSON</button>
          <button id="wipeMonthBtn" class="btn btn-danger btn-sm">Wipe current month</button>
        </div>

        <div id="filesMeta" class="small muted" style="margin-top:12px;"></div>
      </aside>

      <!-- Middle: Add form & table -->
      <section>
        <div class="card" style="margin-bottom:14px;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <div style="font-weight:800">Quick Add Content</div>
              <div class="small muted">Adds into the current month's content_YYYY_MM.json (creates file if missing)</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <input id="searchInput" type="text" placeholder="Search title / url / games" style="width:360px;" />
            </div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:12px;">
            <div>
              <label>Title</label>
              <input id="titleInput" type="text" placeholder="GTA6 trailer leak" />
            </div>
            <div>
              <label>Games (comma separated)</label>
              <input id="gamesInput" type="text" placeholder="GTA6,BF6" />
            </div>
            <div>
              <label>Platform</label>
              <select id="platformInput">
                <option>Article</option><option>Reddit</option><option>YouTube</option><option>YouTubeShorts</option>
                <option>Instagram</option><option>TikTok</option>
              </select>
            </div>
            <div>
              <label>URL</label>
              <input id="urlInput" type="url" placeholder="https://..." />
            </div>

            <div>
              <label>Date & Time (local)</label>
              <input id="dateInput" type="datetime-local" />
            </div>
            <div style="display:flex; align-items:end; gap:8px;">
              <button id="addBtn" class="btn btn-primary">Add Content</button>
              <button id="clearBtn" class="btn btn-ghost">Clear</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:800">All Content Entries</div>
            <div class="small muted">Click "Edit" to open the editor</div>
          </div>

          <div style="overflow:auto; max-height:520px;">
            <table id="entriesTable">
              <thead>
                <tr><th style="width:110px">ID</th><th>Title</th><th style="width:160px">Games</th><th style="width:120px">Platform</th><th style="width:160px">Date</th><th style="width:180px">URL</th><th style="width:120px"></th></tr>
              </thead>
              <tbody id="entriesBody">
                <tr><td colspan="7" class="muted">No entries loaded. Click Refresh.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Right: Filters / Info -->
      <aside class="card">
        <div style="font-weight:800; margin-bottom:8px">Filters</div>

        <div style="margin-bottom:10px;">
          <label>Platforms</label>
          <div class="chips" id="platformChips">
            <label><input type="checkbox" class="plat" value="Article" checked /> Article</label>
            <label><input type="checkbox" class="plat" value="Reddit" checked /> Reddit</label>
            <label><input type="checkbox" class="plat" value="YouTube" checked /> YouTube</label>
            <label><input type="checkbox" class="plat" value="YouTubeShorts" checked /> Shorts</label>
            <label><input type="checkbox" class="plat" value="Instagram" checked /> Instagram</label>
            <label><input type="checkbox" class="plat" value="TikTok" checked /> TikTok</label>
          </div>
        </div>

        <div style="margin-bottom:10px;">
          <label>Timeframe</label>
          <select id="timeframeSelect">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly" selected>Monthly</option>
            <option value="yearly">Yearly</option>
          </select>
        </div>

        <div style="margin-top:14px;">
          <div style="font-weight:700; margin-bottom:6px">Repo Help</div>
          <div class="small muted">
            This admin uses GitHub REST API to read & write files under <code>/data/</code>. You need a PAT with <strong>repo</strong> scope to write.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" aria-hidden="true">
    <div class="modal-window">
      <h3 style="margin-top:0">Edit Entry</h3>

      <div style="display:grid; gap:10px;">
        <div>
          <label>Title</label>
          <input id="editTitle" type="text" />
        </div>
        <div>
          <label>Games (comma separated)</label>
          <input id="editGames" type="text" />
        </div>
        <div>
          <label>Platform</label>
          <select id="editPlatform">
            <option>Article</option><option>Reddit</option><option>YouTube</option><option>YouTubeShorts</option><option>Instagram</option><option>TikTok</option>
          </select>
        </div>
        <div>
          <label>URL</label>
          <input id="editUrl" type="url" />
        </div>
        <div>
          <label>Date & Time (local)</label>
          <input id="editDate" type="datetime-local" />
        </div>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:6px;">
          <button id="deleteBtn" class="btn btn-danger">Delete</button>
          <button id="saveBtn" class="btn btn-primary">Save</button>
          <button id="cancelBtn" class="btn btn-ghost">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
/*
  BOOSTYOU.AI - admin.html
  - login with GitHub PAT
  - load /data/content_YYYY_MM.json files
  - add/edit/delete entries (commit via GitHub API)
  - files are base64 encoded in GitHub contents API
*/

(() => {
  // ---------- Utilities ----------
  const qs = id => document.getElementById(id);
  const el = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));

  function status(msg, ok=true) {
    const bar = qs('statusArea');
    if (!msg) { bar.innerHTML = ''; return; }
    bar.innerHTML = `<div class="status ${ok ? 'ok' : 'err'}">${msg}</div>`;
  }

  // encode unicode safely
  function b64EncodeUnicode(str) {
    return btoa(unescape(encodeURIComponent(str)));
  }
  function b64DecodeUnicode(b64) {
    try {
      return decodeURIComponent(escape(atob(b64)));
    } catch(e) {
      // fallback
      return atob(b64);
    }
  }

  function isoLocalNowInput() {
    const now = new Date();
    const tzOffset = now.getTimezoneOffset() * 60000;
    const local = new Date(now - tzOffset);
    return local.toISOString().slice(0,16);
  }

  function monthFileNameFromDateUTC(d) {
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,'0');
    return `content_${y}_${m}.json`;
  }

  function formatISOForTable(iso) {
    try {
      const d = new Date(iso);
      return d.toISOString().replace('T',' ').replace('Z','');
    } catch(e) {
      return iso;
    }
  }

  // ---------- App state ----------
  const state = {
    token: null, owner: null, repo: null,
    username: null,
    filesMeta: [],         // array of file meta objects from /contents/data
    fileContents: {},      // filename => { sha, arr }
    mergedEntries: [],     // flattened with meta: { ...entry, __file, __index }
    selectedFile: null,
  };

  // ---------- GitHub helpers ----------
  function ghHeaders() {
    return {
      'Authorization': 'token ' + state.token,
      'Accept': 'application/vnd.github.v3+json'
    };
  }

  async function ghGet(path) {
    const url = `https://api.github.com${path}`;
    const res = await fetch(url, { headers: ghHeaders() });
    // return { ok, status, json } style? just handle upstream
    if (!res.ok) {
      const txt = await res.text();
      const err = new Error(`GitHub GET ${res.status} ${res.statusText}: ${txt}`);
      err.status = res.status;
      throw err;
    }
    return res.json();
  }

  async function ghPut(path, bodyObj) {
    const url = `https://api.github.com${path}`;
    const res = await fetch(url, {
      method: 'PUT',
      headers: { ...ghHeaders(), 'Content-Type': 'application/json' },
      body: JSON.stringify(bodyObj)
    });
    if (!res.ok) {
      const txt = await res.text();
      const err = new Error(`GitHub PUT ${res.status} ${res.statusText}: ${txt}`);
      err.status = res.status;
      throw err;
    }
    return res.json();
  }

  // ---------- DOM refs ----------
  const loginPanel = qs('loginPanel');
  const authPanel  = qs('authPanel');
  const whoDisplay = qs('whoDisplay');

  const patField   = qs('patField');
  const ownerField = qs('ownerField');
  const repoField  = qs('repoField');
  const loginBtn   = qs('loginBtn');
  const logoutBtn  = qs('logoutBtn');
  const testBtn    = qs('testBtn');
  const refreshBtnTop = qs('refreshBtnTop');

  const filesBox   = qs('filesBox');
  const filesMeta  = qs('filesMeta');
  const downloadMonthBtn = qs('downloadMonthBtn');
  const wipeMonthBtn = qs('wipeMonthBtn');

  const titleInput  = qs('titleInput');
  const gamesInput  = qs('gamesInput');
  const platformInput = qs('platformInput');
  const urlInput = qs('urlInput');
  const dateInput = qs('dateInput');
  const addBtn = qs('addBtn');
  const clearBtn = qs('clearBtn');
  const searchInput = qs('searchInput');

  const entriesBody = qs('entriesBody');

  const platformCheckboxes = () => qsa('.plat');

  // Edit modal refs
  const editModal = qs('editModal');
  const editTitle = qs('editTitle');
  const editGames = qs('editGames');
  const editPlatform = qs('editPlatform');
  const editUrl = qs('editUrl');
  const editDate = qs('editDate');
  const saveBtn = qs('saveBtn');
  const deleteBtn = qs('deleteBtn');
  const cancelBtn = qs('cancelBtn');

  // ---------- Local storage (settings) ----------
  const LS_KEY = 'boostyou_admin_v3';
  function saveSettings() {
    const obj = { token: state.token, owner: state.owner, repo: state.repo, username: state.username };
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }
  function loadSettings() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return false;
    try {
      const o = JSON.parse(raw);
      state.token = o.token; state.owner = o.owner; state.repo = o.repo; state.username = o.username;
      if (state.token) patField.value = state.token;
      if (state.owner) ownerField.value = state.owner;
      if (state.repo) repoField.value = state.repo;
      return true;
    } catch(e) { return false; }
  }

  // ---------- Auth flow ----------
  async function login() {
    const token = patField.value.trim();
    const owner = ownerField.value.trim();
    const repo  = repoField.value.trim();
    if (!token || !owner || !repo) { status('Enter PAT, owner and repo', false); return; }
    state.token = token; state.owner = owner; state.repo = repo;
    status('Checking token…');
    try {
      const u = await ghGet('/user');
      state.username = u.login || u.name || u.email || 'unknown';
      whoDisplay.textContent = state.username;
      saveSettings();
      showAuthUI(true);
      status(`Authenticated as ${state.username}`, true);
      await refreshAllFiles();
    } catch (err) {
      console.error(err);
      status('Authentication failed: ' + (err.message||err), false);
      state.token = null;
      showAuthUI(false);
    }
  }

  function showAuthUI(auth) {
    if (auth) {
      loginPanel.style.display = 'none';
      authPanel.style.display  = 'flex';
      qs('dashboard')?.style && (qs('dashboard').style.display = 'block');
    } else {
      loginPanel.style.display = 'flex';
      authPanel.style.display  = 'none';
      qs('dashboard')?.style && (qs('dashboard').style.display = 'none');
    }
  }

  function logout() {
    localStorage.removeItem(LS_KEY);
    state.token = null; state.owner = null; state.repo = null; state.username = null;
    whoDisplay.textContent = '—';
    showAuthUI(false);
    status('Logged out');
  }

  // ---------- Files & content ----------
  function isMonthFilename(name) {
    return /^content_\d{4}_\d{2}\.json$/.test(name);
  }

  async function listDataFiles() {
    // GET /repos/:owner/:repo/contents/data
    try {
      const path = `/repos/${state.owner}/${state.repo}/contents/data`;
      const res = await fetch(`https://api.github.com${path}`, { headers: ghHeaders() });
      if (res.status === 404) {
        // no data folder yet
        return [];
      }
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`List data error ${res.status}: ${txt}`);
      }
      const arr = await res.json();
      // filter to files only and our naming pattern
      const files = arr.filter(item => item.type === 'file' && isMonthFilename(item.name));
      return files;
    } catch (err) {
      throw err;
    }
  }

  async function loadFileContent(filename) {
    // GET /repos/:owner/:repo/contents/data/filename
    try {
      const path = `/repos/${state.owner}/${state.repo}/contents/data/${filename}`;
      const res = await fetch(`https://api.github.com${path}`, { headers: ghHeaders() });
      if (res.status === 404) {
        return null;
      }
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(`Load file error ${res.status}: ${txt}`);
      }
      const j = await res.json();
      // j.content is base64
      const decoded = b64DecodeUnicode(j.content);
      let arr = [];
      try { arr = JSON.parse(decoded); if (!Array.isArray(arr)) arr = []; } catch(e){ arr = []; }
      state.fileContents[filename] = { sha: j.sha, arr };
      return state.fileContents[filename];
    } catch (err) {
      throw err;
    }
  }

  async function refreshAllFiles() {
    try {
      status('Loading files...');
      state.filesMeta = []; state.fileContents = {}; state.mergedEntries = [];
      filesBox.innerHTML = '<div class="muted">Loading…</div>';
      const files = await listDataFiles();
      state.filesMeta = files;
      if (!files || files.length === 0) {
        filesBox.innerHTML = '<div class="muted">No content_YYYY_MM.json files found in /data.</div>';
        filesMeta.innerText = '0 files';
        // still try to render table empty
        renderEntries([]);
        status('No files found — create an entry to start', true);
        return;
      }

      // show file list with counts placeholder
      filesBox.innerHTML = files.map(f => `<div class="file-item"><div><strong>${f.name}</strong><div class="small muted">size: ${f.size} bytes</div></div><div><button class="btn btn-ghost btn-sm" data-file="${f.name}">View</button></div></div>`).join('');
      filesMeta.innerText = `${files.length} file(s)`;

      // attach click handlers for View buttons
      qsa('.file-item button').forEach(btn => {
        btn.onclick = (ev) => {
          const name = btn.getAttribute('data-file');
          selectFile(name);
        };
      });

      // load file contents in parallel (safe)
      await Promise.all(files.map(async f => {
        try { await loadFileContent(f.name); } catch(e) { console.warn('load file failed', f.name, e); }
      }));

      // build merged entries list
      buildMergedEntriesFromState();

      // render entries table
      renderEntries(state.mergedEntries);

      status(`Loaded ${files.length} file(s)`, true);
    } catch (err) {
      console.error(err);
      status('Error loading files: ' + (err.message||err), false);
      filesBox.innerHTML = `<div class="muted">Error loading files: ${err.message || err}</div>`;
    }
  }

  function buildMergedEntriesFromState() {
    state.mergedEntries = [];
    for (const filename of Object.keys(state.fileContents)) {
      const obj = state.fileContents[filename];
      const arr = Array.isArray(obj.arr) ? obj.arr : [];
      for (let i = 0; i < arr.length; i++) {
        const entry = arr[i];
        // normalize: ensure game array
        if (entry.game && !Array.isArray(entry.game)) entry.game = [entry.game];
        state.mergedEntries.push(Object.assign({}, entry, { __file: filename, __index: i }));
      }
    }
    // sort by date desc
    state.mergedEntries.sort((a,b) => new Date(b.date) - new Date(a.date));
  }

  function renderEntries(list) {
    const search = (searchInput.value || '').trim().toLowerCase();
    const allowedPlatforms = qsa('.plat').filter(c => c.checked).map(c => c.value);
    const timeframe = qs('timeframeSelect').value;

    // apply timeframe to compute start date
    let since = null;
    const now = new Date();
    if (timeframe === 'daily') { since = new Date(now.getTime() - 24*60*60*1000); }
    else if (timeframe === 'weekly') { since = new Date(now.getTime() - 7*24*60*60*1000); }
    else if (timeframe === 'monthly') { since = new Date(now.getTime() - 30*24*60*60*1000); }
    else if (timeframe === 'yearly') { since = new Date(now.getTime() - 365*24*60*60*1000); }

    const filtered = (list || []).filter(e => {
      // platform filter
      if (allowedPlatforms.length && !allowedPlatforms.includes(e.platform)) return false;
      // timeframe filter
      if (since && e.date) {
        const d = new Date(e.date);
        if (d < since) return false;
      }
      // search
      if (!search) return true;
      if ((e.title||'').toLowerCase().includes(search)) return true;
      if ((e.url||'').toLowerCase().includes(search)) return true;
      if (Array.isArray(e.game) && e.game.join(',').toLowerCase().includes(search)) return true;
      return false;
    });

    if (!filtered || filtered.length === 0) {
      entriesBody.innerHTML = `<tr><td colspan="7" class="muted">No entries match the current filters.</td></tr>`;
      return;
    }

    const rows = filtered.map(e => {
      const games = Array.isArray(e.game) ? e.game.join(', ') : (e.game || '');
      const dateStr = e.date ? formatISOForTable(e.date) : '';
      const shortUrl = e.url ? (e.url.length > 60 ? e.url.slice(0,56)+'…' : e.url) : '';
      return `<tr data-file="${e.__file}" data-index="${e.__index}">
        <td style="font-size:12px; color:var(--muted)">${e.id || ''}</td>
        <td>${escapeHTML(e.title || '')}</td>
        <td class="muted small">${escapeHTML(games)}</td>
        <td>${escapeHTML(e.platform || '')}</td>
        <td class="muted small">${dateStr}</td>
        <td style="max-width:220px; overflow:hidden; text-overflow:ellipsis;"><a href="${escapeHTML(e.url || '#')}" target="_blank" class="muted small">${escapeHTML(shortUrl)}</a></td>
        <td style="text-align:right;">
          <button class="btn btn-ghost btn-sm" data-action="edit" data-file="${e.__file}" data-index="${e.__index}">Edit</button>
          <button class="btn btn-danger btn-sm" data-action="del" data-file="${e.__file}" data-index="${e.__index}">Delete</button>
        </td>
      </tr>`;
    }).join('');
    entriesBody.innerHTML = rows;

    // wire edit/delete buttons
    entriesBody.querySelectorAll('button[data-action]').forEach(b => {
      const act = b.getAttribute('data-action');
      const file = b.getAttribute('data-file');
      const idx  = Number(b.getAttribute('data-index'));
      b.onclick = (ev) => {
        ev.preventDefault();
        if (act === 'edit') openEditModal(file, idx);
        if (act === 'del') deleteEntryConfirm(file, idx);
      };
    });
  }

  // ---------- Add / Write / Update ----------
  async function addEntry() {
    const title = (titleInput.value || '').trim();
    const games = (gamesInput.value || '').split(',').map(s => s.trim()).filter(Boolean);
    const platform = platformInput.value;
    const url = (urlInput.value || '').trim();
    const dateVal = dateInput.value;

    if (!title || !url) {
      status('Title and URL are required', false); return;
    }
    const isoDate = dateVal ? new Date(dateVal).toISOString() : new Date().toISOString();
    const entry = {
      id: Date.now().toString(),
      title, game: games, platform, url, date: isoDate
    };

    // current month file (UTC)
    const now = new Date();
    const filename = monthFileNameFromDateUTC(now);

    try {
      let existing = state.fileContents[filename];
      if (existing && Array.isArray(existing.arr)) {
        const arr = existing.arr.slice();
        arr.push(entry);
        await writeFileToGit(filename, arr, existing.sha, `Add entry to ${filename} — ${title}`);
      } else {
        // file not present: create it
        await writeFileToGit(filename, [entry], null, `Create ${filename} — initial entry: ${title}`);
      }
      // clear inputs
      titleInput.value = ''; gamesInput.value = ''; urlInput.value = ''; dateInput.value = isoLocalNowInput();
      // refresh
      await refreshAllFiles();
      status('Entry added and committed', true);
    } catch (err) {
      console.error(err);
      status('Error adding entry: ' + (err.message||err), false);
    }
  }

  async function writeFileToGit(filename, arr, sha, message) {
    // path: data/filename
    const path = `data/${filename}`;
    const content = b64EncodeUnicode(JSON.stringify(arr, null, 2));
    const body = { message: message || `Update ${filename}`, content };
    if (sha) body.sha = sha;

    try {
      const res = await ghPut(`/repos/${state.owner}/${state.repo}/contents/${path}`, body);
      // update local cache with new sha and content
      if (res && res.content && res.content.name) {
        // fetch content freshly to parse and store arr and sha
        await loadFileContent(res.content.name);
      } else {
        // fallback: update local cache
        state.fileContents[filename] = { sha: res.content && res.content.sha ? res.content.sha : sha, arr };
      }
      return res;
    } catch (err) {
      throw err;
    }
  }

  // ---------- Edit / Delete entry ----------
  function openEditModal(filename, index) {
    const fileObj = state.fileContents[filename];
    if (!fileObj) { status('File not loaded', false); return; }
    const entry = fileObj.arr[index];
    if (!entry) { status('Entry not found', false); return; }

    // populate modal
    qs('editTitle').value = entry.title || '';
    qs('editGames').value = (Array.isArray(entry.game) ? entry.game.join(',') : entry.game || '');
    qs('editPlatform').value = entry.platform || 'Article';
    qs('editUrl').value = entry.url || '';
    // convert ISO to datetime-local
    try {
      const dt = new Date(entry.date || new Date().toISOString());
      const tzOffset = dt.getTimezoneOffset() * 60000;
      const local = new Date(dt - tzOffset).toISOString().slice(0,16);
      qs('editDate').value = local;
    } catch(e) {
      qs('editDate').value = isoLocalNowInput();
    }

    // set modal state
    editModal.dataset.file = filename;
    editModal.dataset.index = index;
    editModal.classList.add('active');
  }

  async function saveEdit() {
    const filename = editModal.dataset.file;
    const index = Number(editModal.dataset.index);
    const fileObj = state.fileContents[filename];
    if (!fileObj) { status('File not loaded', false); return; }
    const arr = Array.isArray(fileObj.arr) ? fileObj.arr.slice() : [];
    if (index < 0 || index >= arr.length) { status('Invalid index', false); return; }

    const updated = {
      ...arr[index],
      title: (editTitle.value || '').trim(),
      game: (editGames.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      platform: editPlatform.value,
      url: (editUrl.value || '').trim(),
      date: new Date(editDate.value).toISOString()
    };
    arr[index] = updated;

    try {
      await writeFileToGit(filename, arr, fileObj.sha, `Edit entry in ${filename} — ${updated.title}`);
      editModal.classList.remove('active');
      await refreshAllFiles();
      status('Entry updated', true);
    } catch (err) {
      console.error(err);
      status('Error updating entry: ' + (err.message||err), false);
    }
  }

  async function deleteEntryConfirm(filename, index) {
    if (!confirm('Delete this entry from the monthly file? This will commit the change.')) return;
    try {
      const fileObj = state.fileContents[filename];
      if (!fileObj) { status('File not loaded', false); return; }
      const arr = (Array.isArray(fileObj.arr) ? fileObj.arr.slice() : []).filter((_,i) => i !== index);
      await writeFileToGit(filename, arr, fileObj.sha, `Delete entry from ${filename}`);
      await refreshAllFiles();
      status('Entry deleted', true);
    } catch (err) {
      console.error(err);
      status('Error deleting entry: ' + (err.message||err), false);
    }
  }

  // handle delete from modal
  async function deleteFromModal() {
    const filename = editModal.dataset.file;
    const index = Number(editModal.dataset.index);
    if (!confirm('Are you sure you want to DELETE this entry?')) return;
    await deleteEntryConfirm(filename, index);
    editModal.classList.remove('active');
  }

  // ---------- Utility actions ----------
  async function downloadCurrentMonth() {
    const fn = monthFileNameFromDateUTC(new Date());
    const fileObj = state.fileContents[fn];
    if (!fileObj) { alert('Current month file not found'); return; }
    const blob = new Blob([JSON.stringify(fileObj.arr, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fn; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  async function wipeCurrentMonthFile() {
    if (!confirm('Wipe current month file (this will set it to an empty array and commit)?')) return;
    const fn = monthFileNameFromDateUTC(new Date());
    const fileObj = state.fileContents[fn];
    if (!fileObj) { alert('File not present'); return; }
    try {
      await writeFileToGit(fn, [], fileObj.sha, `Wipe ${fn} (set empty)`);
      await refreshAllFiles();
      status('Current month wiped (set to empty array)', true);
    } catch (err) {
      console.error(err);
      status('Error wiping file: '+(err.message||err), false);
    }
  }

  // escape helper for html output
  function escapeHTML(s) {
    if (!s && s !== 0) return '';
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ---------- Event wiring ----------
  loginBtn.addEventListener('click', login);
  logoutBtn.addEventListener('click', logout);
  testBtn.addEventListener('click', async () => {
    if (!state.token) { status('No token set', false); return; }
    try {
      const u = await ghGet('/user');
      status('Token OK — ' + (u.login || u.name), true);
    } catch (err) {
      status('Token test failed: ' + (err.message||err), false);
    }
  });
  refreshBtnTop.addEventListener('click', () => refreshAllFiles());
  qs('refreshBtn') && qs('refreshBtn').addEventListener('click', () => refreshAllFiles());

  addBtn.addEventListener('click', addEntry);
  clearBtn.addEventListener('click', () => { titleInput.value=''; gamesInput.value=''; urlInput.value=''; dateInput.value = isoLocalNowInput(); });

  searchInput.addEventListener('input', () => renderEntries(state.mergedEntries));
  qsa('.plat').forEach(c => c.addEventListener('change', () => renderEntries(state.mergedEntries)));
  qs('timeframeSelect').addEventListener('change', () => renderEntries(state.mergedEntries));

  // modal events
  saveBtn.addEventListener('click', saveEdit);
  deleteBtn.addEventListener('click', deleteFromModal);
  cancelBtn.addEventListener('click', () => editModal.classList.remove('active'));
  // close modal on backdrop click
  editModal.addEventListener('click', (ev) => { if (ev.target === editModal) editModal.classList.remove('active'); });

  downloadMonthBtn.addEventListener('click', downloadCurrentMonth);
  wipeMonthBtn.addEventListener('click', wipeCurrentMonthFile);

  // ---------- Init ----------
  (function init() {
    // prefill date inputs
    dateInput.value = isoLocalNowInput();
    editDate.value = isoLocalNowInput();

    loadSettings();
    if (state.token && state.owner && state.repo) {
      // try auto-login
      (async () => {
        try {
          status('Auto-checking stored token…');
          const u = await ghGet('/user');
          state.username = u.login || u.name;
          whoDisplay.textContent = state.username;
          showAuthUI(true);
          await refreshAllFiles();
          status('Auto-authenticated as ' + state.username, true);
        } catch (err) {
          console.warn('Auto-login failed', err);
          status('', true);
          showAuthUI(false);
        }
      })();
    } else {
      showAuthUI(false);
    }
  })();

})();
</script>
</body>
</html>
